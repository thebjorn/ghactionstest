name: CI/CD Pipeline

on: [ push, pull_request, workflow_dispatch ]

env:
  DEFAULT_BRANCH: master
  PIP_CACHE_DIR: /tmp/pipcache

jobs:
  ci:
    name: Continuous Integration
    runs-on: ${{ matrix.os }}
    # container: thebjorn/pydeps-agent:ci-${{ matrix.python-version }}
    outputs:
      package_version: ${{ steps.proj_ver_determiner.outputs.package_version }}
      package_version_tag: ${{ steps.proj_ver_determiner.outputs.package_version_tag }}
      latest_github_tag: ${{ steps.proj_ver_determiner.outputs.latest_github_tag }}
      should_deploy: ${{ steps.proj_ver_determiner.outputs.should_deploy }}
    strategy:
      matrix:
        python-version: [ 2.7, 3.9 ]
        os: [ubuntu-latest, windows-latest, macos-latest]
    env:
      PYVER: ${{ matrix.python-version}}
      LOGDIR: ./ghlogs/${{ matrix.python-version}}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: setup directories
        shell: bash
        run: |
          mkdir -p $PIP_CACHE_DIR
          mkdir -p $LOGDIR

      - name: printenv
        shell: python
        run: |
          import os,sys
          print(sys.version_info)
          for k, v in os.environ.items():
              print(k, v)
      
      - name: pipinstall
        run: |
          pip install -r requirements.txt
          pip list | tee $LOGDIR/pip-list.log

      - name: display result
        run: |
          pwd
          yamldirs .
          ls -l .
          ls -l ./ghlogs
